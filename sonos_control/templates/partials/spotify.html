<body data-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
  {% if user.is_authenticated %}
    <div class="d-flex justify-content-between">
      <form id="spotify-search-form" method="GET" class="d-flex w-100">
        <input type="text"
               id="spotify-search-input"
               name="query"
               placeholder="Search for songs, albums, artists"
               class="form-control mr-2"
               style="width: 60%">
        <button type="submit"
                id="spotify-search-button"
                class="btn btn-primary"
                style="width: 20%;
                       height: 60%">Search</button>
        <button type="button"
                id="clear-search-button"
                class="btn btn-secondary"
                style="width: 20%;
                       height: 60%">Clear</button>
      </form>
    </div>
    <!-- Placeholder for dynamic content -->
    <div id="spotify-content">
      <h4 class="mt-2 text-dark bg-white p-2">Recently Played</h4>
      <div id="recently-played-list" class="row">
        <div>Loading...</div>
      </div>
      <h4 class="mt-2 text-dark bg-white p-2">Favorites</h4>
      <div id="favorite-tracks-list" class="row">
        <div>Loading...</div>
      </div>
    </div>
    <form action="{% url 'social:disconnect' 'spotify' %}"
          method="POST"
          style="display: inline">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.path }}">
      <button type="submit" class="btn btn-danger">Logout of Spotify</button>
    </form>
  {% else %}
    <h2>Spotify Control</h2>
    <p>You need to log in to access Spotify features.</p>
    <a href="{% url 'social:begin' 'spotify' %}?show_dialog=true&next={{ request.path }}"
       class="btn btn-primary">Login with Spotify</a>
  {% endif %}
  <!-- Long Press Context Menu Modal -->
  <div class="modal fade"
       id="contextMenuModal"
       tabindex="-1"
       role="dialog"
       aria-labelledby="contextMenuModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contextMenuModalLabel">Choose an Action</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <button class="btn btn-primary btn-block" id="modal-play-btn">Play Now</button>
          <button class="btn btn-primary btn-block" id="modal-add-to-front-btn">Play Next</button>
          <button class="btn btn-primary btn-block" id="modal-add-to-back-btn">Add to Queue</button>
        </div>
      </div>
    </div>
  </div>
</body>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const isAuthenticated = document.body.getAttribute('data-authenticated') === 'true';
    if (!isAuthenticated) return;
  
    const contentContainer = document.getElementById('spotify-content'); // Container for search and original content
    const searchForm = document.getElementById('spotify-search-form');
    const clearButton = document.getElementById('clear-search-button');
  
    // ---- Fetch the Initial Spotify Data ----
    fetchSpotifyData();
  
    // ---- Handle Form Submission for Both Enter Key and Button ----
    searchForm.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent the form from submitting and reloading the page
  
      const query = document.getElementById('spotify-search-input').value.trim();
      if (!query) {
        alert('Please enter a search term');
        return;
      }
  
      fetchSearchResults(query);
    });
  
    // ---- Handle Clearing Search Results ----
    clearButton.addEventListener('click', function() {
      //clear the search text
      document.getElementById('spotify-search-input').value = '';
      fetchSpotifyData();  // Re-fetch and restore original content
    });
  
    // ---- Spotify Data Fetching and Display ----
    function fetchSpotifyData() {
      fetch("{% url 'fetch_spotify_data' %}")
        .then(response => response.json())
        .then(data => {
          populateSpotifyData(data);  // Populate Recently Played and Favorites
        })
        .catch(error => console.error('Error fetching Spotify data:', error));
    }
  
    function fetchSearchResults(query) {
      fetch(`{% url 'spotify_search' %}?query=${query}`)
        .then(response => response.json())
        .then(data => {
          displaySearchResults(data.search_results);  // Display search results in content container
        })
        .catch(error => console.error('Error fetching search results:', error));
    }
  
    function populateSpotifyData(data) {
      // Clear current content but keep the structure
      contentContainer.innerHTML = `
        <h4 class="mt-2 text-dark bg-white p-2">Recently Played</h4>
        <div id="recently-played-list" class="row"></div>
        <h4 class="mt-2 text-dark bg-white p-2">Favorites</h4>
        <div id="favorite-tracks-list" class="row"></div>
      `;
  
      const recentlyPlayedList = document.getElementById("recently-played-list");
      const favoriteTracksList = document.getElementById("favorite-tracks-list");
  
      // Populate Recently Played
      if (data.recently_played.length) {
        data.recently_played.forEach(track => {
          const trackItem = createTrackItem(track, track.uri);
          recentlyPlayedList.appendChild(trackItem);             
        });
      } else {
        recentlyPlayedList.innerHTML = '<div class="col-12 text-white">No recently played tracks found</div>';
      }
  
      // Populate Favorites
      if (data.favorite_tracks.length) {
        data.favorite_tracks.forEach(track => {
          const trackItem = createTrackItem(track, track.uri);
          favoriteTracksList.appendChild(trackItem);          
        });
      } else {
        favoriteTracksList.innerHTML = '<div class="col-12 text-white">No favorite tracks found</div>';
      }
    }
  
    function displaySearchResults(results) {
      const contentContainer = document.getElementById('spotify-content'); // Make sure this is defined
    
      // Clear current content and display search results
      contentContainer.innerHTML = ''; // Clear content
      
      if (results.length === 0) {
        const noResultsMessage = document.createElement('p');
        noResultsMessage.textContent = 'No results found for your search.';
        contentContainer.appendChild(noResultsMessage);
      } else {
        const header = document.createElement('h4');
        header.textContent = 'Search Results:';
        contentContainer.appendChild(header);
    
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('row'); // Create a div for the row layout
    
        results.forEach(track => {
          const trackItem = createTrackItem(track, track.uri); // Create track item using the modified function
          rowDiv.appendChild(trackItem); // Append the track item to the row div
        });
    
        contentContainer.appendChild(rowDiv); // Append the row div to the content container
      }
    }
    
  
    function createTrackItem(track, trackUri) {
      const albumArt = track.album_art
        ? `<a href="javascript:void(0);">
             <img src="${track.album_art}" alt="${track.name} Album Art" class="img-fluid album-art">
           </a>`
        : '';
    
      // Create a wrapper element
      const trackElement = document.createElement('div');
      trackElement.classList.add('col-2', 'd-flex', 'flex-column', 'align-items-center', 'mb-1', 'track-item');
      trackElement.setAttribute('data-track-uri', trackUri);
    
      // Add inner HTML (album art and track name)
      trackElement.innerHTML = `
        ${albumArt}
        <span class="mt-2 text-center text-white">${track.name}</span>
      `;
    
      // Add the event listeners for long press and click events
      trackElement.addEventListener('mousedown', handlePressStart);
      trackElement.addEventListener('touchstart', handlePressStart);
    
      trackElement.addEventListener('mouseup', handlePressEnd);
      trackElement.addEventListener('mouseleave', handlePressEnd);
      trackElement.addEventListener('touchend', handlePressEnd);
    
      trackElement.addEventListener('click', handleClick); // Handle short click event
    
      return trackElement;
    }
    
  
    // Long press and click functions
    let pressTimer;
    let longPressDuration = 500; // 500ms for long press detection
    let selectedTrackUri = '';  // Store the currently selected track URI
  
    function handlePressStart(event) {
      selectedTrackUri = event.currentTarget.dataset.trackUri;
      pressTimer = window.setTimeout(() => {
        console.log('Long press detected');
        $('#contextMenuModal').modal('show');
      }, longPressDuration);
    }
  
    function handlePressEnd() {
      clearTimeout(pressTimer);
    }
  
    function handleClick() {
      if (pressTimer) {
        clearTimeout(pressTimer);
        playOnActiveSpeaker(selectedTrackUri);  // Short click: Play track
      }
    }
  
    // ---- Modal Actions for Tracks ----
    document.getElementById('modal-play-btn').addEventListener('click', function() {
      playOnActiveSpeaker(selectedTrackUri);
      $('#contextMenuModal').modal('hide');
    });
  
    document.getElementById('modal-add-to-front-btn').addEventListener('click', function() {
      addToActiveSpeakerQueue(selectedTrackUri, 'next');
      $('#contextMenuModal').modal('hide');
    });
  
    document.getElementById('modal-add-to-back-btn').addEventListener('click', function() {
      addToActiveSpeakerQueue(selectedTrackUri, 'end');
      $('#contextMenuModal').modal('hide');
    });
  });
  
  
  
{% comment %}   
    fetch("{% url 'fetch_spotify_data' %}")
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }
  
        const recentlyPlayedList = document.getElementById("recently-played-list");
        const favoriteTracksList = document.getElementById("favorite-tracks-list");
  
        // Clear loading message
        recentlyPlayedList.innerHTML = '';
        favoriteTracksList.innerHTML = '';
  
        // Helper function to create track item
        const createTrackItem = (track, trackUri) => {
          const albumArt = track.album_art 
            ? `<a href="javascript:void(0);">
                 <img src="${track.album_art}" alt="${track.name} Album Art" class="img-fluid album-art">
               </a>`
            : '';
  
            return `
            <div class="col-2 d-flex flex-column align-items-center mb-1 track-item" data-track-uri="${trackUri}" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
              ${albumArt}
              <span class="mt-2 text-center text-white">${track.name}</span>
            </div>
          `;
        };
  
        // Populate Recently Played
        if (data.recently_played.length) {
          data.recently_played.forEach(track => {
            recentlyPlayedList.innerHTML += createTrackItem(track, track.uri);
          });
        } else {
          recentlyPlayedList.innerHTML = '<div class="col-12 text-white">No recently played tracks found</div>';
        }
  
        // Populate Favorite Tracks
        if (data.favorite_tracks.length) {
          data.favorite_tracks.forEach(track => {
            favoriteTracksList.innerHTML += createTrackItem(track, track.uri);
          });
        } else {
          favoriteTracksList.innerHTML = '<div class="col-12 text-white">No favorite tracks found</div>';
} {% endcomment %}
        // Long press logic starts here
               
      {% comment %} })
      .catch(error => console.error('Error fetching Spotify data:', error));
}); {% endcomment %}
  {% comment %}
  let draggedTrackUri = '';
  let isTouchDragging = false;

  function handleDragStart(event) {
      // Store the track URI of the dragged item
      draggedTrackUri = event.currentTarget.getAttribute('data-track-uri');
      event.dataTransfer.effectAllowed = 'move';  // Set the effect for drag-and-drop
  }

 function handleTouchStart(event) {
    const touch = event.touches[0];
    const target = event.currentTarget;

    draggedTrackUri = target.getAttribute('data-track-uri');

    // Create a ghost element to represent the dragged item
    ghostElement = target.cloneNode(true);  // Clone the dragged element
    ghostElement.style.position = 'absolute';
    ghostElement.style.opacity = '0.7';
    ghostElement.style.pointerEvents = 'none';  // Make sure it doesn't interfere with other elements
    ghostElement.classList.add('ghost-drag');
    document.body.appendChild(ghostElement);

    // Position the ghost element at the touch start point
    ghostElement.style.left = `${touch.clientX}px`;
    ghostElement.style.top = `${touch.clientY}px`;
  }

  function handleTouchMove(event) {
    if (!ghostElement) return;  // Exit if there's no ghost element

    const touch = event.touches[0];
    
    // Move the ghost element along with the finger
    ghostElement.style.left = `${touch.clientX}px`;
    ghostElement.style.top = `${touch.clientY}px`;

    event.preventDefault();  // Prevent default behavior like scrolling
  }

function handleTouchEnd(event) {
  // When touch ends, simulate a drop
  isTouchDragging = false;

    // Remove the ghost element
  if (ghostElement) {
      document.body.removeChild(ghostElement);
      ghostElement = null;
  }  
  
  dropTarget = document.elementFromPoint(event.changedTouches[0].clientX, event.changedTouches[0].clientY);

  // Traverse up the DOM to find the correct drop zone (in this case, the speaker-dropzone)
  while (dropTarget && dropTarget !== document && (!dropTarget.classList || !dropTarget.classList.contains('speaker-dropzone'))) {
    dropTarget = dropTarget.parentNode;
}

// If no valid drop zone found, log a message and return
if (!dropTarget || dropTarget === document) {
    console.log('Touch drag ended outside a valid drop zone');
    return;
}

  const speakerUid = dropTarget.getAttribute('data-speaker-uid');
  handleDrop(event, speakerUid);
}
  
  function handleDragEnd(event) {
      // Clear the dragged track URI after dragging
      draggedTrackUri = '';
  }
  
  function handleDragOver(event) {
      // Prevent the default to allow dropping
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';  // Specify the allowed drop effect
  }
  
  function handleDrop(event, speakerUid) {
      // Prevent the default action (browser may redirect on drop)
      event.preventDefault();
  
      // Ensure a track URI is available
      if (!draggedTrackUri) {
          return;
      }
  
      // Call the function to add the dragged track to the Sonos speaker's queue
      addToActiveSpeakerQueue(draggedTrackUri, speakerUid);
} {% endcomment %}
function addToActiveSpeakerQueue(trackUri, position='end') {
    // Assuming you have an active speaker identified
    const speakerUid = getActiveSpeaker();  // You need to implement this function to return the speaker's UID
    const service = "spotify";  // Fixed value for Spotify service

    if (!speakerUid) {
        alert('No active speaker selected');
        return;
    }
    else
    {
        console.log(`Adding track to queue: ${trackUri}`);
    } 

    // Prepare the POST request data
    const data = new FormData();
    data.append('speakerUid', speakerUid);
    data.append('service', service);
    data.append('track_uri', trackUri);
    data.append('position', position);

    // Get CSRF token from the form (if available)
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Send the POST request to the Django view
    fetch("{% url 'queue_track' %}", {
        method: 'POST',
        body: data,
        headers: {
            'X-CSRFToken': csrfToken  // CSRF token for security
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Track added to Sonos queue:', data.message);
        } else {
            console.error('Error adding track:', data.message);
        }
    })
    .catch(error => console.error('Error in request:', error));
  }

  function playOnActiveSpeaker(trackUri) {
    const speakerUid = getActiveSpeaker();  // You need to implement this function to return the speaker's UID
    const service = "spotify";  // Fixed value for Spotify service

    if (!speakerUid) {
        alert('No active speaker selected');
        return;
    }

    // Prepare the POST request data
    const data = new FormData();
    data.append('speakerUid', speakerUid);
    data.append('service', service);
    data.append('track_uri', trackUri);

    // Get CSRF token from the form (if available)
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Send the POST request to the Django view
    fetch("{% url 'play_uri' %}", {
        method: 'POST',
        body: data,
        headers: {
            'X-CSRFToken': csrfToken  // CSRF token for security
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Track added to Sonos queue:', data.message);
        } else {
            console.error('Error adding track:', data.message);
        }
    })
    .catch(error => console.error('Error in request:', error));
  }  

function getActiveSpeaker() {
  // Get the currently active tab using the 'active' class
  const activeTab = document.querySelector('.nav-link.active');
  
  if (activeTab) {
      // Retrieve the speaker UID from the active tab's ID or data attribute
      const speakerUid = activeTab.id.replace('speaker-tab-', '');  // Strip 'speaker-tab-' from the ID to get the UID
      return speakerUid;
  } else {
      console.error('No active speaker found');
      return null;
  }
}
  
</script>

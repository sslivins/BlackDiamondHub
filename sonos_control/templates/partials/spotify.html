{% if user.is_authenticated %}
  <h2>Spotify Control</h2>
  <form id="spotify-search-form"
        method="GET"
        action="{% url 'spotify_search' %}">
    <input type="text"
           name="query"
           placeholder="Search for songs, albums, artists"
           class="form-control mb-3">
    <button type="submit" class="btn btn-primary">Search</button>
  </form>
  <form action="{% url 'social:disconnect' 'spotify' %}"
        method="POST"
        style="display: inline">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ request.path }}">
    <button type="submit" class="btn btn-danger">Logout</button>
  </form>
  <h4>Recently Played</h4>
  <ul id="recently-played-list" class="list-group mb-4">
    <li class="list-group-item">Loading...</li>
  </ul>
  <h4>Favorites</h4>
  <ul id="favorite-tracks-list" class="list-group">
    <li class="list-group-item">Loading...</li>
  </ul>
</div>
</ul>
{% else %}
<h2>Spotify Control</h2>
<p>You need to log in to access Spotify features.</p>
<a href="{% url 'social:begin' 'spotify' %}?show_dialog=true&next={{ request.path }}"
   class="btn btn-primary">Login with Spotify</a>
{% endif %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    fetch("{% url 'fetch_spotify_data' %}")
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }

        const recentlyPlayedList = document.getElementById("recently-played-list");
        const favoriteTracksList = document.getElementById("favorite-tracks-list");

        // Clear loading message
        recentlyPlayedList.innerHTML = '';
        favoriteTracksList.innerHTML = '';

        // Populate Recently Played
        data.recently_played.forEach(track => {
          recentlyPlayedList.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><strong>${track.name}</strong> by ${track.artist}</span>
              <button class="btn btn-primary" onclick="playOnSonos('${track.uri}')">Play</button>
            </li>
          `;
        });

        // Populate Favorite Tracks
        data.favorite_tracks.forEach(track => {
          favoriteTracksList.innerHTML += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><strong>${track.name}</strong> by ${track.artist}</span>
              <button class="btn btn-primary" onclick="playOnSonos('${track.uri}')">Play</button>
            </li>
          `;
        });
      })
      .catch(error => console.error('Error fetching Spotify data:', error));
  });

  function playOnSonos(uri) {
    // Logic to play on Sonos speakers
    console.log("Playing on Sonos:", uri);
  }
  
</script>
